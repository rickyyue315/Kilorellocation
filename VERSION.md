# 版本更新記錄

## v2.1.1 (2026-01-30)

### 新增功能
- **新增F模式：目標優化**
  - 針對Target欄位填數字作為優先接收目標
  - 其他店鋪按C模式補0需求計算
  - 支持跨OM配對，HD不能轉到HA/HB/HC
  - 更新系統為六模式系統：A/B/C/D/E/F

### 業務邏輯更新
- **F模式(目標優化)**：
  - 轉出條件：
    - ND類型：全數轉出
    - RF類型：可忽視最小庫存要求，但保護最高銷量店鋪
  - 轉出類型：F模式ND轉出 / F模式RF轉出
  - 接收條件：
    - Target數字：優先接收目標
    - 未標Target的店鋪：按C模式重點補0
  - 優先級邏輯：
    - Target數字優先接收
    - 其他店鋪按C模式補0需求計算
  - HD限制：
    - HD店鋪的轉出絕對不能到HA/HB/HC店鋪

### 技術更新
- 更新 `data_processor.py`：
  - 在 optional_columns 中添加 'Target' 欄位
  - 修改 `read_excel_file` 方法，能夠讀取並標準化 *Target* 欄位
  - 自動創建空 Target 欄位（若上傳文件中不存在）
  - 添加日誌記錄 *Target* 欄位的識別狀態

- 更新 `business_logic.py`：
  - 添加 `self.mode_f = "目標優化"`
  - 修改 `identify_sources` 方法，添加F模式的轉出識別邏輯
  - 修改 `identify_destinations` 方法，添加F模式的接收邏輯（Target優先+C模式補0）
  - 修改 `match_transfers` 方法，增加F模式路由到專用匹配方法
  - 新增 `_match_transfers_f_mode` 方法，實現F模式的Target優先和跨OM限制邏輯
  - 更新 `generate_transfer_recommendations` 方法的模式驗證，支持F模式
  - 更新所有相關方法的文檔字符串

- 更新 `app.py`：
  - 更新頁面標題為 "庫存調貨建議系統 v2.1.1"
  - 更新模式選擇，添加 "F: 目標優化" 選項
  - 更新模式說明，添加F模式的詳細說明
  - 更新模式名稱轉換邏輯，支持F模式

### 重要說明
- *Target* 欄位識別不分大小寫，系統會自動標準化為 'Target'
- F模式上傳的Excel文件需要包含 *Target*、Target 或其他大小寫組合的欄位
- F模式下，Target數字優先接收，未標Target的店鋪會按C模式補0需求計算
- HD和其他OM的限制規則遵循客戶的業務規則：HD不能轉到同一OM集群的其他OM

---

## v1.9.9 (2026-01-29)

### 新增功能
- **新增E模式：強制轉出**
  - 針對標記為 *ALL* 的商品行進行全數強制轉出
  - 只有被標記為 *ALL* 的行才會成為轉出源
  - 接收店鋪限制為RF類型，接收上限為Safety Stock的2倍
  - 優先同OM配對，當該OM無法接收時放寬跨OM配對
  - HD店鋪絕對不能轉到HA/HB/HC的店鋪
  - 更新系統為五模式系統：A/B/C/D/E

### 業務邏輯更新
- **E模式(強制轉出)**：
  - 轉出條件：該行在 *ALL* 欄位中有任何非空白文字
  - 轉出數量：全數轉出（不考慮安全庫存）
  - 轉出類型：E模式強制轉出
  - 接收條件：
    - 只接收RF店鋪
    - 當前庫存(SaSa Net Stock + Pending Received) < Safety Stock × 2
    - 接收上限 = Safety Stock × 2
  - 優先級邏輯：
    - Phase 1：優先配對同OM的接收店鋪
    - Phase 2：當同OM無法接收時，放寬跨OM配對（但受HD限制）
    - **Phase 3：C模式回退** - 當其他OM未有店舖涉及強制轉出時，可按照C模式照常做重點補0
  - HD限制：
    - HD店鋪的轉出絕對不能到HA/HB/HC店鋪

### 技術更新
- 更新 `data_processor.py`：
  - 在 optional_columns 中添加 'ALL' 欄位
  - 修改 `read_excel_file` 方法，能夠讀取並標準化 *ALL* 欄位（不分大小寫）
  - 自動創建空 ALL 欄位（若上傳文件中不存在）
  - 添加日誌記錄 *ALL* 欄位的識別狀態

- 更新 `business_logic.py`：
  - 添加 `self.mode_e = "強制轉出"`
  - 修改 `identify_sources` 方法，添加E模式的強制轉出識別邏輯
  - 修改 `identify_destinations` 方法，添加E模式的接收邏輯（RF限制+上限為2倍Safety Stock）
  - 修改 `match_transfers` 方法，增加E模式路由到專用匹配方法
  - 新增 `_match_transfers_e_mode` 方法，實現E模式的優先級和跨OM限制邏輯
  - 更新 `generate_transfer_recommendations` 方法的模式驗證，支持E模式
  - 更新所有相關方法的文檔字符串

- 更新 `app.py`：
  - 更新頁面標題為 "庫存調貨建議系統 v1.9.9"
  - 更新模式選擇，添加 "E: 強制轉出" 選項
  - 更新模式說明，添加E模式的詳細說明
  - 更新模式名稱轉換邏輯，支持E模式

### 重要說明
- *ALL* 欄位識別不分大小寫，系統會自動標準化為 'ALL'
- E模式上傳的Excel文件需要包含 *ALL*、ALL 或其他大小寫組合的欄位
- E模式下，只有被標記的行才會進行轉出，其他行被忽略
- HD和其他OM的限制規則遵循客戶的業務規則：HD不能轉到同一OM集群的其他OM

---

## v1.9.8 (2026-01-26)

### 新增功能
- **新增D模式：清貨轉貨**
  - 針對ND類型且無銷售記錄的店鋪進行清貨處理
  - 實現避免1件餘貨的特殊邏輯
  - 更新系統為四模式系統：A/B/C/D

### 業務邏輯更新
- **D模式(清貨轉貨)**：
  - 轉出條件：ND類型且 Last Month Sold Qty = 0 且 MTD Sold Qty = 0
  - 轉出類型：ND清貨轉出
  - 特殊規則：避免1件餘貨
    - 如果轉出後會剩餘1件，則嘗試多轉1件（使剩餘為0）
    - 若無法多轉，則少轉1件（使剩餘為2）
    - 確保轉出後剩餘庫存為0件或≥2件
  - 接收規則：遵循A模式(保守轉貨)的接收規則

### 技術更新
- 更新 `business_logic.py`：
  - 添加 `self.mode_d = "清貨轉貨"`
  - 修改 `identify_sources` 方法，添加D模式的ND清貨轉出識別
  - 修改 `_match_by_priority` 方法，添加避免1件餘貨的特殊處理
  - 修改 `_create_recommendation_note` 方法，添加ND清貨轉出的說明
  - 更新模式驗證邏輯，支持D模式
  - 更新所有相關方法的文檔字符串
  - 更新版本號至 v1.9.8

- 更新 `app.py`：
  - 更新頁面標題為 "庫存調貨建議系統 v1.9.8"
  - 更新模式選擇，添加 "D: 清貨轉貨" 選項
  - 更新模式說明，添加D模式的詳細說明
  - 更新模式名稱轉換邏輯，支持D模式
  - 更新操作指引，添加D模式的說明
  - 更新系統資訊，更新版本號和核心功能描述
  - 更新圖表顯示邏輯，支持D模式的ND清貨轉出類型

- 更新 `README.md`：
  - 更新系統概述，改為四模式系統
  - 更新功能特點，添加D模式特殊功能說明
  - 更新使用說明，添加D模式的說明
  - 更新業務邏輯詳解，添加D模式的完整說明
  - 更新更新日誌，添加v1.9.8的版本記錄

- 新增 `test_mode_d.py`：
  - 創建D模式專用測試腳本
  - 驗證ND清貨轉出邏輯的正確性
  - 驗證避免1件餘貨功能的有效性
  - 提供詳細的測試結果和統計分析

---

**開發者：Ricky**  
**最後更新：2026-01-26**
